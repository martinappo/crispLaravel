angular.module("portfolioCtrl",["angularFileUpload"]).controller("portfolioController",function($scope,$http,artwork,FileUploader){var uploader=$scope.uploader=new FileUploader({url:"/upload"});$scope.artworkData={},$scope.submitted=!1,$scope.master={},$scope.loading=!1,$scope.uploads={},$scope.filesValidator=!1,$scope.addedArtworkId=0,$scope.$on("onRepeatLast",function(){$(window).scroll(function(){$(window).width()<768&&$(".el").each(function(index,el){var posTop=$(el).position().top,posBottom=posTop+$(el).height(),currentTop=$(window).scrollTop(),height=$(window).height(),currentBottom=currentTop+height;posTop>currentTop&&currentBottom>posBottom?$(el).addClass("hovered"):$(el).removeClass("hovered")})})}),artwork.get().success(function(data){$scope.artworks=data,$scope.loading=!1}),$scope.addWork=function(){$scope.loading=!0,$scope.artworkData.order=999,artwork.save($scope.artworkData).success(function(data){data.success?artwork.get().success(function(){$scope.addedArtworkId=data.artworkId,uploader.uploadAll()}):($scope.submitted=!0,$scope.loading=!1)}).error(function(data){console.log(data)})},$scope.deleteWork=function(id){$scope.loading=!0,artwork.destroy(id).success(function(){artwork.get().success(function(getData){$scope.artworks=getData,$scope.loading=!1})})},$scope.fillEditWork=function(id){console.log("filling fields.."),artwork.getOne(id).success(function(data){$scope.artworkData=data,$.each($scope.artworkData.images,function(index,imageData){var item=new FileUploader.FileItem(uploader,{lastModifiedDate:new Date,name:imageData.url});item.formData.push({id:imageData.id}),console.log("pushing item to queue: "+JSON.stringify(item.file.name)),uploader.queue.push(item)}),console.log("fields filled"),$scope.loading=!1})},$("#editWork").on("hidden.bs.modal",function(){$scope.reset()}),$scope.editWork=function(event){$scope.loading=!0,artwork.update($scope.artworkData).success(function(data){data.success?artwork.get().success(function(){console.log("Update item success. ArtworkId: "+data.artworkId),$scope.addedArtworkId=data.artworkId,console.log("starting to upload files"),uploader.uploadAll()}):($scope.submitted=!0,$scope.loading=!1)}).error(function(data){console.log(data)});try{event.preventDefault()}catch(err){console.log("Couldnt prevent default")}},$scope.reset=function(){$scope.artworkData=angular.copy($scope.master),$scope.submitted=!1,$scope.addWorkForm.title.$dirty=!1,$scope.addWorkForm.type.$dirty=!1,$scope.loading=!1,uploader.clearQueue(),artwork.get().success(function(data){$scope.artworks=data,$scope.loading=!1})},$scope.sortableOptions={stop:function(){{var order=0;$scope.artworks.map(function(item){item.order=order,order++,artwork.update(item).success(function(data){data.success?artwork.get().success(function(){console.log("Update item success. ArtworkId: "+data.artworkId)}):($scope.submitted=!0,$scope.loading=!1)}).error(function(data){console.log(data)})})}}},$scope.remove=function(item){var id=item.formData[0].id;0!=id?(console.log("deleting item: "+JSON.stringify(id)),item.file.name==$scope.artworkData.hover&&($scope.artworkData.hover=""),item.file.name==$scope.artworkData.cover&&($scope.artworkData.cover=""),artwork.destroyImage(id).success(function(){artwork.get().success(function(getData){$scope.artworks=getData})})):console.log("removing item: "+item.file.name),item.remove()},$scope.radioChanged=function(){$scope.filesValidator=($scope.artworkData.hover+"").length&($scope.artworkData.cover+"").length},uploader.onAfterAddingFile=function(item){console.info("onAfterAddingFile"),item.formData.push({id:!1})},uploader.onSuccessItem=function(fileItem,response){console.log("on success item"),console.info("response: "+JSON.stringify(response))},uploader.onCompleteAll=function(){console.log("on complete all uploads"),$("#addWork").modal("hide"),$("#editWork").modal("hide"),$scope.reset()},uploader.onErrorItem=function(fileItem,response){console.log("error item: "),console.info("onErrorItem",JSON.stringify(response))},uploader.onBeforeUploadItem=function(item){item.formData.push({artworkId:$scope.addedArtworkId}),item.formData.push({hover:$scope.artworkData.hover}),item.formData.push({cover:$scope.artworkData.cover}),console.log("Starting to upload: "+item.file.name+" id: "+JSON.stringify(item.formData))}}),angular.module("singlePortfolioCtrl",[]).controller("singlePortfolioController",function($scope,$http,artwork){artwork.get().success(function(data){$scope.artworks=data,$scope.loading=!1}),$("#bodyContainer").hide(),$scope.$on("onRepeatLast",function(){$(function(){function nextSlide(){var selectedTab=tabs.tabs("option","active");return count>selectedTab+1?tabs.tabs("option","active",selectedTab+1):selectedTab+1==count&&tabs.tabs("option","active",0),!1}function prevSlide(){var selectedTab=tabs.tabs("option","active");return selectedTab>0?tabs.tabs("option","active",selectedTab-1):0==selectedTab&&tabs.tabs("option","active",count-1),!1}function nextImage(){var selectedTab=tabs.tabs("option","active"),imagesDiv=$("#artworks .portfolio-element:nth-of-type("+(selectedTab+1)+") .portfolio-image"),imagesCount=imagesDiv.children("div").length,selectedImageTab=imagesDiv.tabs("option","active");return imagesCount>selectedImageTab+1?imagesDiv.tabs("option","active",selectedImageTab+1):selectedImageTab+1==imagesCount&&imagesDiv.tabs("option","active",0),!1}function prevImage(){var selectedTab=tabs.tabs("option","active"),imagesDiv=$("#artworks .portfolio-element:nth-of-type("+(selectedTab+1)+") .portfolio-image"),imagesCount=imagesDiv.children("div").length,selectedImageTab=imagesDiv.tabs("option","active");return selectedImageTab>0?imagesDiv.tabs("option","active",selectedImageTab-1):0==selectedImageTab&&imagesDiv.tabs("option","active",imagesCount-1),!1}var activeIndex=$(".portfolio-element").index($("div#artworks-"+artworkId)),tabs=$("#artworks").tabs({show:{effect:"fade",duration:100},hide:{effect:"fade",duration:100},select:function(){jQuery(this).css("height",jQuery(this).height()),jQuery(this).css("overflow","hidden")},show:function(){jQuery(this).css("height","auto"),jQuery(this).css("overflow","visible")},active:activeIndex}),count=$(".portfolio-element").length;$(".portfolio-image").each(function(){$(this).tabs({show:{effect:"fade",duration:100},hide:{effect:"fade",duration:100},select:function(){jQuery(this).css("height",jQuery(this).height()),jQuery(this).css("overflow","hidden")},show:function(){jQuery(this).css("height","auto"),jQuery(this).css("overflow","visible")}})}),$("#bodyContainer").fadeIn("slow"),$("#next").click(function(e){e.preventDefault(),nextSlide()}),$("#prev").click(function(e){e.preventDefault(),prevSlide()}),$(document).keydown(function(e){switch(e.which){case 37:prevSlide();break;case 38:nextImage();break;case 39:nextSlide();break;case 40:prevImage();break;default:return}e.preventDefault()}),$("#artworks").on("swipeleft",prevSlide),$("#artworks").on("swiperight",nextSlide),$(".portfolio-image").on("swipeleft",prevImage),$(".portfolio-image").on("swiperight",nextImage)})})}),angular.module("artworkService",[]).factory("artwork",function($http){return{getOne:function(artworkId){return $http({method:"Get",url:"/allArtworks/"+artworkId,headers:{"Content-Type":"application/x-www-form-urlencoded"}})},get:function(){return $http.get("/allArtworks")},save:function(artworkData){return $http({method:"POST",url:"/portfolio",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(artworkData)})},update:function(artworkData){return $http({method:"PUT",url:"/portfolio/"+artworkData.id,headers:{"Content-Type":"application/x-www-form-urlencoded"},data:$.param(artworkData)})},destroy:function(id){return $http["delete"]("/portfolio/"+id)},destroyImage:function(id){return $http["delete"]("/image/"+id)}}});var portfolioApp=angular.module("portfolioApp",["portfolioCtrl","singlePortfolioCtrl","artworkService","ui.sortable"]);portfolioApp.directive("backImg",function(){return function(scope,element,attrs){var url=attrs.backImg,img=$("<img/>").attr("src",url);img.load(function(){element.css({"background-image":"url("+url+")"})})}}),portfolioApp.directive("backImgFade",function(){return function(scope,element,attrs){var url=attrs.backImgFade;element.hide(),$("<img/>").attr("src",url).load(function(){element.css({"background-image":"url("+url+")"}),element.fadeIn()})}}),portfolioApp.directive("onLastRepeat",function(){return function(scope,element,attrs){scope.$last&&setTimeout(function(){scope.$emit("onRepeatLast",element,attrs)},1)}});